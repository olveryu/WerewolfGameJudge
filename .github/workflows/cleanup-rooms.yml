name: Cleanup Old Rooms

on:
  schedule:
    # 每天 UTC 03:00 运行 (北京时间 11:00)
    - cron: '0 3 * * *'
  workflow_dispatch: # 允许手动触发

permissions: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete rooms older than 24 hours
        run: |
          # Calculate timestamp for 24 hours ago
          CUTOFF=$(date -u -d '24 hours ago' '+%Y-%m-%dT%H:%M:%S.000Z')
          echo "Deleting rooms created before: $CUTOFF"

          # Delete old rooms via Supabase REST API
          response=$(curl -s -X DELETE \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/rooms?created_at=lt.$CUTOFF")

          # Count deleted rooms
          count=$(echo "$response" | jq 'length // 0')

          if [ "$count" -gt 0 ]; then
            echo "✅ Deleted $count old room(s)"
            echo "$response" | jq -r '.[].code' | while read code; do
              echo "  - Room: $code"
            done
          else
            echo "✅ No rooms older than 24 hours found"
          fi
