name: Warm API Functions

on:
  schedule:
    # 每 5 分钟 ping 一次，保持 Vercel Serverless 实例存活 + postgres 连接热
    - cron: '*/5 * * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Warm game function (DB connection)
        run: |
          # 触发 game/[action] function + postgres 连接
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST -H "Content-Type: application/json" \
            -d '{"roomCode":"0000","hostUid":"warmup"}' \
            "https://werewolf-judge.vercel.app/api/game/start")
          echo "game/start: $code (expected 400)"

      - name: Warm night function (DB connection)
        run: |
          # 触发 game/night/[action] function + postgres 连接
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST -H "Content-Type: application/json" \
            -d '{"roomCode":"0000","hostUid":"warmup","seat":0,"role":"wolf"}' \
            "https://werewolf-judge.vercel.app/api/game/night/action")
          echo "game/night/action: $code (expected 400)"

      - name: Health check
        run: |
          code=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://werewolf-judge.vercel.app/api/health")
          echo "health: $code"
          if [ "$code" -ne 200 ]; then
            echo "::warning::Health check returned $code"
          fi
