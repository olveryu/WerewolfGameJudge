/**
 * quickQuestions - 快捷问题池与生成逻辑
 *
 * 纯函数 + 静态数据，无副作用。
 * 根据游戏上下文和聊天记录动态生成 4 道快捷问题。
 * 读取 gameState 进行问题匹配。不调用 service，不修改 state。
 */

import type { GameState } from '@werewolf/game-engine/protocol/types';
import { randomPick } from '@werewolf/game-engine/utils/random';
import { shuffleArray } from '@werewolf/game-engine/utils/shuffle';

// ── 问题池 ───────────────────────────────────────────────

/** 通用问题池 - 不在游戏中时使用（≤10字） */
const GENERAL_QUESTIONS = [
  // 基础规则
  '狼人杀基本规则？',
  '游戏怎么获胜？',
  '出局有哪些方式？',
  '什么是遗言环节？',
  '投票怎么进行？',
  '如何判断出局？',
  // 阵营概念
  '好人怎么配合？',
  '狼人怎么隐藏？',
  '狼队怎么配合？',
  '好人阵营有哪些？',
  '狼人阵营有哪些？',
  '第三方阵营是啥？',
  // 核心术语
  '什么是金水银水？',
  '什么是查杀？',
  '什么是悍跳？',
  '什么是对跳？',
  '什么是站边？',
  '什么是踩人拉人？',
  '什么是做票？',
  '什么是警上警下？',
  // 发言策略
  '怎么分析发言？',
  '首轮怎么发言？',
  '好人发言重点？',
  '怎么听逻辑链？',
  '怎么判断真假？',
  '怎么回应质疑？',
  '末位发言技巧？',
  '怎么总结发言？',
  // 投票策略
  '投票该投谁？',
  '弃票好不好？',
  '怎么看投票站边？',
  '归票是什么意思？',
  '怎么分析票型？',
  // 信息分析
  '怎么判断狼人？',
  '怎么保护神职？',
  '怎么分析夜间？',
  '狼人怎么选刀？',
  '怎么分析遗言？',
  '怎么分析站位？',
  '如何排号码位？',
  // 进阶概念
  '什么是锤？',
  '什么是银水狼？',
  '什么是穿衣服？',
  '什么是裸跳？',
  '什么是深水狼？',
  '什么是自刀？',
  '什么是倒钩？',
  '什么是预言家坑？',
  '首日怎么排听？',
  '怎么上警发言？',
];

/** 根据角色生成相关问题（≤10字） */
const ROLE_QUESTIONS: Record<string, string[]> = {
  // ── 村民 ──
  villager: [
    '村民怎么发挥？',
    '村民怎么发言？',
    '村民要站边吗？',
    '村民能抗推吗？',
    '村民怎么保护自己？',
    '村民要不要冲票？',
    '村民该不该踩人？',
    '村民投票策略？',
    '村民首日怎么听？',
    '村民能骗刀吗？',
  ],
  // ── 神职 ──
  seer: [
    '预言家先查谁？',
    '预言家怎么自保？',
    '预言家何时跳？',
    '查杀要公布吗？',
    '被悍跳怎么办？',
    '预言家遗言说啥？',
    '首晚查边还是中？',
    '验人优先级顺序？',
    '预言家被刀咋办？',
    '预言家不跳行吗？',
  ],
  witch: [
    '女巫首晚要救吗？',
    '毒药什么时候用？',
    '女巫能自救吗？',
    '女巫被刀要不要自救？',
    '毒错人怎么办？',
    '解药什么时候用？',
    '女巫被恐惧咋办？',
    '先救还是先毒？',
    '女巫怎么隐藏？',
    '女巫何时跳身份？',
  ],
  guard: [
    '守卫首晚守谁？',
    '守卫配合预言家？',
    '守卫能守自己吗？',
    '守错人怎么办？',
    '能连续守一人吗？',
    '守卫女巫同守？',
    '守卫何时跳牌？',
    '守卫被恐惧咋办？',
    '守卫怎么猜刀口？',
    '守卫遗言说什么？',
  ],
  hunter: [
    '猎人何时开枪？',
    '被毒能开枪吗？',
    '猎人怎么发挥？',
    '猎人枪打谁好？',
    '猎人要暴露吗？',
    '猎人能骗刀吗？',
    '猎人遗言怎么说？',
    '猎人开枪时机？',
    '猎人跳不跳身份？',
    '猎人被恐惧了？',
  ],
  idiot: [
    '白痴被投会怎样？',
    '翻牌后能投票吗？',
    '白痴怎么发言？',
    '白痴要不要跳牌？',
    '白痴该悍跳吗？',
    '白痴翻牌后能力？',
    '白痴能骗刀吗？',
    '白痴投票策略？',
    '白痴什么时候翻？',
    '白痴遗言怎么说？',
  ],
  knight: [
    '骑士决斗怎么用？',
    '骑士何时翻牌？',
    '骑士决斗谁？',
    '决斗到好人咋办？',
    '骑士要不要藏？',
    '骑士优先决斗谁？',
    '骑士怎么判断狼？',
    '骑士首日决斗？',
    '骑士遗言怎么说？',
    '骑士能骗刀吗？',
  ],
  magician: [
    '魔术师技能？',
    '交换座位有啥用？',
    '魔术师怎么配合？',
    '魔术师首晚换谁？',
    '魔术师保预言家？',
    '交换影响狼刀吗？',
    '魔术师怎么隐藏？',
    '交换后查验咋算？',
    '魔术师遗言说啥？',
    '魔术师骗刀策略？',
  ],
  witcher: [
    '猎魔人怎么用？',
    '猎魔人何时狩猎？',
    '猎到好人会怎样？',
    '猎魔人免疫毒药？',
    '猎魔人首晚干嘛？',
    '猎魔人优先猎谁？',
    '猎魔人发言策略？',
    '猎魔人怎么判断？',
    '猎魔人被刀咋办？',
    '猎魔人遗言说啥？',
  ],
  psychic: [
    '通灵师和预言家？',
    '通灵师怎么验？',
    '通灵师能查到啥？',
    '通灵师首晚查谁？',
    '通灵师要跳吗？',
    '通灵师怎么配合？',
    '通灵师能查狼王？',
    '通灵师被刀咋办？',
    '通灵师遗言说啥？',
    '通灵师比预言家？',
  ],
  dreamcatcher: [
    '摄梦人怎么用？',
    '梦游者知不知道？',
    '摄梦人首晚选谁？',
    '连续梦游会出局？',
    '摄梦人出局连带？',
    '梦游者免疫伤害？',
    '摄梦人保人策略？',
    '摄梦人发言技巧？',
    '摄梦人被刀咋办？',
    '摄梦人怎么配合？',
  ],
  graveyardKeeper: [
    '守墓人能查谁？',
    '守墓人首晚能力？',
    '守墓人怎么发言？',
    '守墓人查放逐？',
    '守墓人要跳吗？',
    '守墓人信息可靠？',
    '守墓人怎么配合？',
    '守墓人何时发言？',
    '守墓人遗言说啥？',
    '守墓人被刀咋办？',
  ],
  // ── 狼人 ──
  wolf: [
    '狼人刀人技巧？',
    '狼人怎么伪装？',
    '刀完怎么发言？',
    '狼人怎么悍跳？',
    '狼人怎么互保？',
    '狼人首刀选谁？',
    '狼人发言策略？',
    '狼人怎么站边？',
    '狼人投票策略？',
    '狼人自刀策略？',
  ],
  wolfQueen: [
    '狼美人特殊技能？',
    '狼美人魅惑谁？',
    '魅惑者殉情规则？',
    '狼美人出局连带？',
    '狼美人免疫狼刀？',
    '狼美人发言策略？',
    '狼美人怎么伪装？',
    '狼美人首晚魅谁？',
    '狼美人被查验？',
    '狼美人怎么配合？',
  ],
  wolfKing: [
    '白狼王技能是啥？',
    '白狼王何时自爆？',
    '自爆后带走谁？',
    '白狼王能刀吗？',
    '白狼王发言策略？',
    '白狼王被投票？',
    '白狼王怎么伪装？',
    '白狼王自爆时机？',
    '白狼王配合狼队？',
    '白狼王遗言规则？',
  ],
  darkWolfKing: [
    '黑狼王技能是啥？',
    '黑狼王被刀开枪？',
    '黑狼王怎么发挥？',
    '黑狼王像猎人吗？',
    '黑狼王发言策略？',
    '黑狼王被毒能反？',
    '黑狼王怎么伪装？',
    '黑狼王怎么配合？',
    '黑狼王首刀策略？',
    '黑狼王什么时候开？',
  ],
  nightmare: [
    '梦魇技能是啥？',
    '梦魇怎么配合？',
    '梦魇恐惧谁好？',
    '梦魇首晚恐惧谁？',
    '连续恐惧一人？',
    '梦魇恐惧到狼？',
    '梦魇发言策略？',
    '梦魇怎么伪装？',
    '梦魇首晚互认吗？',
    '梦魇被查验结果？',
  ],
  gargoyle: [
    '石像鬼技能？',
    '石像鬼看到啥？',
    '石像鬼能查验？',
    '石像鬼不参刀？',
    '石像鬼和狼互认？',
    '石像鬼独狼模式？',
    '石像鬼发言策略？',
    '石像鬼怎么伪装？',
    '石像鬼首晚查谁？',
    '石像鬼被查验？',
  ],
  bloodMoon: [
    '血月使徒技能？',
    '血月自爆效果？',
    '血月封印技能？',
    '血月末狼规则？',
    '血月发言策略？',
    '血月怎么配合？',
    '血月怎么伪装？',
    '血月自爆时机？',
    '血月被投票？',
    '血月被查验？',
  ],
  wolfRobot: [
    '机械狼技能？',
    '机械狼能互认？',
    '机械狼学习谁？',
    '机械狼首晚干嘛？',
    '机械狼被查验？',
    '机械狼独狼带刀？',
    '机械狼发言策略？',
    '机械狼学了能用？',
    '机械狼怎么配合？',
    '机械狼怎么伪装？',
  ],
  spiritKnight: [
    '恶灵骑士技能？',
    '恶灵免疫伤害？',
    '恶灵反伤规则？',
    '恶灵被查验？',
    '恶灵被毒会怎样？',
    '恶灵怎么出局？',
    '恶灵发言策略？',
    '恶灵怎么配合？',
    '恶灵怎么伪装？',
    '恶灵能自爆吗？',
  ],
  masquerade: [
    '假面技能是啥？',
    '假面怎么伪装？',
    '假面防毒规则？',
    '假面首晚干嘛？',
    '假面被查验结果？',
    '假面和狼互认吗？',
    '假面发言策略？',
    '假面投票策略？',
    '假面遗言说啥？',
    '假面怎么配合？',
  ],
  wolfWitch: [
    '狼巫技能是啥？',
    '狼巫查验谁好？',
    '狼巫首晚查谁？',
    '狼巫能查队友？',
    '狼巫发言策略？',
    '狼巫怎么伪装？',
    '狼巫查到纯白？',
    '狼巫怎么配合？',
    '狼巫被查验？',
    '狼巫遗言说啥？',
  ],
  // ── 村民 / 伪装身份 ──
  mirrorSeer: [
    '灯影预言家技能？',
    '灯影和预言家区别？',
    '灯影首晚查谁？',
    '灯影要跳预言家？',
    '灯影被悍跳？',
    '灯影怎么发言？',
    '灯影遗言说啥？',
    '灯影怎么自保？',
    '灯影查验结果？',
    '灯影投票策略？',
  ],
  drunkSeer: [
    '酒鬼预言家技能？',
    '酒鬼查验准吗？',
    '酒鬼首晚查谁？',
    '酒鬼怎么判断？',
    '酒鬼要跳身份吗？',
    '酒鬼发言策略？',
    '酒鬼遗言怎么说？',
    '酒鬼怎么自保？',
    '酒鬼投票策略？',
    '酒鬼和预言家？',
  ],
  pureWhite: [
    '纯白之女技能？',
    '纯白查验谁好？',
    '纯白查到狼出局？',
    '纯白首晚查谁？',
    '纯白要跳身份吗？',
    '纯白怎么配合？',
    '纯白发言策略？',
    '纯白被刀咋办？',
    '纯白遗言说啥？',
    '纯白和狼巫互动？',
  ],
  dancer: [
    '舞者技能是啥？',
    '舞者怎么发言？',
    '舞者防毒规则？',
    '舞者首晚干嘛？',
    '舞者怎么配合？',
    '舞者要跳身份吗？',
    '舞者被查验结果？',
    '舞者投票策略？',
    '舞者遗言说啥？',
    '舞者怎么自保？',
  ],
  silenceElder: [
    '禁言长老技能？',
    '禁言长老禁谁？',
    '禁言效果持续？',
    '禁言长老首晚？',
    '禁言能禁自己？',
    '禁言长老发言？',
    '禁言长老配合？',
    '禁言长老被刀？',
    '禁言长老遗言？',
    '禁言长老投票？',
  ],
  votebanElder: [
    '禁票长老技能？',
    '禁票长老禁谁？',
    '禁票效果持续？',
    '禁票长老首晚？',
    '禁票能禁自己？',
    '禁票长老发言？',
    '禁票长老配合？',
    '禁票长老被刀？',
    '禁票长老遗言？',
    '禁票长老投票？',
  ],
  // ── 第三方 ──
  slacker: [
    '混子什么阵营？',
    '混子胜利条件？',
    '混子首晚选谁？',
    '混子知道榜样吗？',
    '混子怎么发言？',
    '混子被查验结果？',
    '混子怎么站边？',
    '混子选到狼人？',
    '混子要暴露吗？',
    '混子投票策略？',
  ],
  wildChild: [
    '野孩子什么阵营？',
    '野孩子胜利条件？',
    '野孩子首晚选谁？',
    '榜样出局会怎样？',
    '野孩子变狼规则？',
    '野孩子怎么发言？',
    '野孩子被查验？',
    '野孩子怎么站边？',
    '野孩子要暴露吗？',
    '野孩子投票策略？',
  ],
};

/**
 * 根据游戏上下文和聊天记录生成快捷问题（共4道）
 */
export function generateQuickQuestions(state: GameState | null, mySeat: number | null): string[] {
  const questions: string[] = [];
  const used = new Set<string>();

  const add = (q: string) => {
    if (!used.has(q)) {
      questions.push(q);
      used.add(q);
    }
  };

  // 1. 固定 — 板子角色技能介绍
  if (state?.templateRoles && state.templateRoles.length > 0) {
    add('本局角色技能介绍？');
  }

  // 2. 动态 — 我的角色相关（第一条）
  if (mySeat !== null && state?.players[mySeat]?.role) {
    const myRole = state.players[mySeat]?.role;
    if (myRole && ROLE_QUESTIONS[myRole]) {
      const available = ROLE_QUESTIONS[myRole].filter((q) => !used.has(q));
      if (available.length > 0) add(randomPick(available));
    }
  }

  // 3. 动态 — 我的角色相关（第二条）
  if (mySeat !== null && state?.players[mySeat]?.role) {
    const myRole = state.players[mySeat]?.role;
    if (myRole && ROLE_QUESTIONS[myRole]) {
      const available = ROLE_QUESTIONS[myRole].filter((q) => !used.has(q));
      if (available.length > 0) add(randomPick(available));
    }
  }

  // 4. 通用问题补满 4 个
  if (questions.length < 4) {
    const remaining = 4 - questions.length;
    const available = GENERAL_QUESTIONS.filter((q) => !used.has(q));
    const shuffled = shuffleArray(available);
    for (let i = 0; i < remaining && i < shuffled.length; i++) {
      questions.push(shuffled[i]);
    }
  }

  return questions.slice(0, 4);
}
